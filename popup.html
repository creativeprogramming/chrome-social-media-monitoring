<html>
<head>
<title>Social Media Monitoring : Popup</title>

<link rel="stylesheet" href="css/content.css" type="text/css" media="all" />
<script type="text/javascript" src="probe_manager.js"></script>
<script type="text/javascript" src="probe.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="lib/3rdparty/jquery.effects.core.min.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAATfHumDbW3OmRByfquHd3SRTRERdeAiwZ9EeJWta3L_JZVS0bOBRQeZgr4K0xyVKzUdnnuFl8X9PX0w&sensor=false"></script>
<script type="text/javascript" src="lib/geo_search.js"></script>


<script type="text/javascript"><!--
var probeManager = chrome.extension.getBackgroundPage().getProbeManager();

var probesList;
var currentProbe;
var currentProbeDiv;
var currentSelectedService = "twitter";

var currentLocation = undefined;


var probes, template, serviceIcon, inputTag, spanTag, inputAvgWeek, inputAvgDay, btnOptions, btnRefresh;

var port = chrome.extension.connect({name: "social-media-monitoring"});

/*
 * XXX: comented because of crash on windows 7 with chrome 5.0.342.3
 */
//port.postMessage({requestGeolocation:'true'});

port.onMessage.addListener(function(msg) {
	  if (msg.update) {
		  probeObj = msg.update;
		  console.log('onMessage[update]:' + probeObj);

		/*
		 * get right element from probe list
		 */
		  var probeHTMLObj = $('#f_' + probeObj.id);

			 if (probeHTMLObj){

				 //$(probeHTMLObj).addClass('warn');
				 $(probeHTMLObj).removeClass('loader');
				 
				 $(' > span#tag',probeHTMLObj).html($(' > input#tag_input',probeHTMLObj).val());
				 
				 $(' > span#tag',probeHTMLObj).removeClass('hd');
				 $(' > input#tag_input',probeHTMLObj).addClass('hd');
				 $(' > span.avgWeek',probeHTMLObj).html(probeObj.shortTermTweetsPerMin);
				 $(' > span.avgDay',probeHTMLObj).html(probeObj.longTermTweetsPerMin);
				 $(' > span#btnOptions',probeHTMLObj).removeClass('hd');

				 
				 $(' > span#btnRefresh',probeHTMLObj).removeClass('hd');
				 $(' > span#btnRefresh',probeHTMLObj).removeClass('reloading');
				 $(' > span#btnRefresh',probeHTMLObj).addClass('idle');
				 
				 
				 if(probeObj.latitude == undefined){
					 $(' > span#btnOptions',probeHTMLObj).addClass('disabled');
				 }
				 
				 $('#show-button').attr("disabled", "");

				 
			 }

	  }
	  if (msg.alert) {
		  probeObj = msg.alert;
		  console.log('onMessage[alert]:' + probeObj);
		  
		  var probeHTMLObj = $('#f_' + probeObj.id);

		  if (probeHTMLObj){
		  	$(probeHTMLObj).addClass('marker');
		  	$(probeHTMLObj).removeClass('loader');
		  	$(' > span#btnRefresh',probeHTMLObj).addClass('idle');
		  }
	  }
	  if (msg.onLocationResult) {
		  currentLocation = msg.onLocationResult;
	  }  
});

$(document).ready(function() {
	$("#btnAdd").click(function() {

		/*
		 * check if probe is filled
		 */
		var ignore = false;
		$('#f').each(function(i){

			 var tagObj = $(' > input#tag_input.tag',this);
			 var probeValue = tagObj.val();
			 console.log('probeValue:' + probeValue);
			 if (!probeValue){
				 $(tagObj).animate({backgroundColor: "#f4aeae"}, "fast").animate({backgroundColor: "#fffff"}, "fast");
				 ignore = true;
				 return false;
			 }
			 
			 if($(tagObj).is(':visible')){
				 $(tagObj).animate({backgroundColor: "#f4aeae"}, "fast").animate({backgroundColor: "#fffff"}, "fast");
				 ignore = true;
				 return false;
			 }

			 
			 
		});

		if(!ignore){
			currentSelectedService = "twitter";
			addProbeHTML();
			addButtonListeners();
		}  
	});

});

function openResults() {

	var probes = probeManager.loadProbes();
	
	if ($('#open_results').val() == 'open_in_new_window') {
		chrome.windows.create({url: buildProbeQuery(probes[0])});
		chrome.windows.getLastFocused(function (window) {

			var count = 0;
			for (var j in probes) {
				count++;
				if(count == 1){
					continue;
				}
					chrome.tabs.create({url: buildProbeQuery(probes[j]), windowId: window.windowId});
			}
		
		});
	} else {	
	
		for (var i in probes) {
			chrome.tabs.create({url: buildProbeQuery(probes[i])});
		}
	
	}
	
}


--></script>

<style type="text/css">
  @import url("http://www.google.com/uds/css/gsearch.css");
  @import url("http://www.google.com/uds/solutions/localsearch/gmlocalsearch.css");
</style>
</head>
<body onload="setTimeout(init,0);" onunload="GUnload();" class="popup">

<div id="options">

<a href="#" id="back" onclick="back();">Go back to the list</a>

<div id="geolocform">
	<form action="javascript:void(0);" onsubmit="showAddress(this.location.value); return false;"> 
   	  <input id="location" type="text" name="location" value="Search Location" onfocus="if(this.value=='Search Location'){this.value='';}">
   	  <select id="distance" name="distance"><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option><option value="60">60</option><option value="70">70</option><option value="80">80</option><option value="90">90</option><option value="100">100</option><option value="200">200</option></select>
   	  <select id="unit" name="unit"><option value="km">kilometres</option>
   	  <!--  <option value="mi">miles</option>-->
   	  </select>
   	  <br>
	</form>
</div>
   	
<div id="map_canvas"></div>

<span id="lat"></span> 
<span id="lng"></span>
<button type="button" id="enable_location">Enable</button>
<button type="button" id="disable_location">Disable</button>
<span id="save_status">Saved</span>

</div>
<script type="text/javascript">
function init() {

	var probes = probeManager.loadProbes();


	console.log('TODO: add communication with background.html\n port.postMessage({probeTagLoad: tagProbe})');
	/*
	 * initialize template
	 */
	probesList = document.getElementById('probes');
	template = xpath('//ol[@id="template"]/li', document);
	serviceIcon  = xpath('//span[@id="iconService"]', template);
	spanTag  = xpath('//span[@id="tag"]', template);
	inputTag = xpath('//input[@id="tag_input"]', template);
	inputAvgWeek = xpath('//span[@class="avgWeek"]', template);
	inputAvgDay	 = xpath('//span[@class="avgDay"]', template);
	btnOptions	 = xpath('//span[@id="btnOptions"]', template);
	btnRefresh 	 = xpath('//span[@id="btnRefresh"]', template);

	if(probes){
		$('#show-button').attr("disabled", "");
		for (var i in probes) {
			addProbeHTML(probes[i]);
		}
		addButtonListeners();
	}
	
	chrome.extension.getBackgroundPage().resetAlerts();
}

function addButtonListeners(){
	$("span#btnRemove").click(function() {
		/*
		 * get selected probe id
		 */		
		var probeDiv = $(this).parent('.probe');
		var strDivId = probeDiv.attr('id');
		strDivId = strDivId.substring(2);

		/*
		 * remove
		 */
		probeManager.removeProbeById(strDivId);

		/*
		 * remove from HTML
		 */
	    probeDiv.slideUp("fast",function(){
				probeDiv.remove();
	    });

		if(probeManager.countProbes() == 0){
	    	chrome.extension.getBackgroundPage().showNoActiveProbes()
	    	$('#show-button').attr("disabled", "true");
		}

		/*
		 * Update probes
		 */

/*		
		chrome.extension.getBackgroundPage().updateProbes(function(count) {
			//dummy function
			console.log('updateProbes.callback:' + count);
		  });
*/			

	});
	/*
	 * show options
	 */
	$("span#btnOptions").click(function() {
		/*
		 * get selected probe id
		 */		
		currentProbeDiv = $(this).parent('.probe');
		var strDivId = currentProbeDiv.attr('id');
		strDivId = strDivId.substring(2);

		currentProbe = probeManager.getProbeById(strDivId);

		$("#save_status").css('display','none');

		
		if(currentProbe.latitude != undefined){
			$("#enable_location").css('display','inline');
			$("#enable_location").html('set');
			$("#disable_location").css('display','inline');

		}else{
			$("#enable_location").html('enable');
			$("#enable_location").css('display','inline');
			$("#disable_location").css('display','none');
		}
		
		if (currentProbe.latitude != undefined && currentProbe.longitude != undefined)
			initMapSearch(currentProbe.latitude, currentProbe.longitude);
		else if(currentLocation !== undefined) {
			initMapSearch(currentLocation.latitude, currentLocation.longitude);
		}
		else {
			initMapSearch(37.4328, -122.077); //hello google ;)
		}
		
		$("#distance").val(currentProbe.radius);
		
		$("div#options").slideDown("fast");
	});

	/*
	 * refresh results
	 */
	$("span#btnRefresh").mousedown(function() {
		/*
		 * get selected probe id
		 */		
		currentProbeDiv = $(this).parent('.probe');
		var strDivId = currentProbeDiv.attr('id');
		strDivId = strDivId.substring(2);
		//$(currentProbeDiv).addClass('loader');
		
		$(' > span#btnRefresh',currentProbeDiv).addClass('reloading');
		
		currentProbe = probeManager.getProbeById(strDivId);

		port.postMessage({probeTagChanged: currentProbe});
	});

	$("span#iconService").click(function() {
		/*
		 * get selected probe id
		 */		
		currentProbeDiv = $(this).parent('.probe');
		var strDivId = currentProbeDiv.attr('id');
		strDivId = strDivId.substring(2);

		var probeObj = probeManager.getProbeById(strDivId);
		var radius = ""; 
		if (probeObj.radius != undefined){
			radius = probeObj.radius;
		}

		window.open(buildProbeQuery(probeObj)); 
		return false;
		
	});
	
	$("#enable_location").click(function() {

		/*
		 * reload probe (if it was in between changed)
		 */
		currentProbe = probeManager.getProbeById(currentProbe.id);

		currentProbe.latitude = $("#lat").html();
		currentProbe.longitude  = $("#lng").html();
		currentProbe.radius  = $("#distance").val();
		
		
		probeManager.setProbe(currentProbe);

		$(' > span#btnOptions',currentProbeDiv).removeClass('disabled');
		//$(currentProbeDiv).addClass('loader');
		$(' > span#btnRefresh',currentProbeDiv).addClass('reloading');
		
		$('#save_status').fadeIn('fast');
		$('#save_status').fadeOut(3000);
		$("div#options").css('display','none');
		$(this).css('display','none');
		$("#disable_location").css('display','none');		

		port.postMessage({probeTagChanged: currentProbe});

		
		
	});
	
	$("#disable_location").click(function() {

		/*
		 * reload probe (if it was in between changed)
		 */
		currentProbe = probeManager.getProbeById(currentProbe.id);

		currentProbe.latitude = undefined;
		currentProbe.longitude  = undefined;
		currentProbe.radius  = undefined;

		probeManager.setProbe(currentProbe);

		//$(currentProbeDiv).addClass('loader');
		$(' > span#btnRefresh',currentProbeDiv).addClass('reloading');
		$(' > span#btnOptions',currentProbeDiv).addClass('disabled');		
		$('#save_status').fadeIn('fast');
		$('#save_status').fadeOut(3000);
		$("div#options").css('display','none');
		$(this).css('display','none');
		$("#enable_location").css('display','none');
		
		

		port.postMessage({probeTagChanged: currentProbe});		

	});
	
	

    $(".probe").click(function () {
    	       $(".probe").removeClass("selected");
    	       $(this).addClass("selected");
    	      }
    ).mouseover( function () {
		 //$(' > #btnRemove',this).removeClass("hd");
		 $(this).addClass("selected");
		    
		}
	).mouseout( function () {
		//$(' > #btnRemove',this).addClass("hd");
	    $(this).removeClass("selected");
	    	 
	    }
	);

    $("input#tag_input").keypress(function (e) {  
        if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
			save();
        	return false;  
        } else {  
            return true;  
        }  
    });  
	
    
}


function addProbeHTML(probeObj){

	if(probeObj){		

		spanTag.innerHTML = probeObj.query;


		serviceIcon.setAttribute('class','service_' + probeObj.serviceId);
		
		spanTag.setAttribute('class','span_tag');			
		inputTag.setAttribute('class','tag hd');
		
		inputTag.setAttribute('value',probeObj.query);
		inputAvgWeek.innerHTML = probeObj.shortTermTweetsPerMin;
		inputAvgDay.innerHTML = probeObj.longTermTweetsPerMin;

		if(probeObj.latitude == undefined){
			btnOptions.setAttribute('class','disabled');
		}else{
			btnOptions.setAttribute('class','');
		}
		// copy node and update
		item = template.cloneNode(true);	  
		item.setAttribute('id','f_' + probeObj.id);
		item.setAttribute('class','probe');

		/*
		 * mark probe if in marker array
		 */
		if (chrome.extension.getBackgroundPage().ifMarkerSet(probeObj.id)){
			item.setAttribute('class','probe marker');
		}

		probesList.appendChild(item);
		
	}else{

		serviceIcon.setAttribute('class','service_' + currentSelectedService);
		
		spanTag.setAttribute('class','span_tag hd');
		spanTag.innerHTML = '';		
		inputTag.setAttribute('class','tag');
			
		inputTag.setAttribute('value','');
		inputAvgWeek.innerHTML = '0';
		inputAvgDay.innerHTML = '0';
		btnOptions.setAttribute('class','hd');
		btnRefresh.setAttribute('class','hd');
				
		// copy node and update
		item = template.cloneNode(true);	  
		item.setAttribute('id','f');
		item.setAttribute('class','probe');

		
		probesList.appendChild(item);

		$("#f.probe > input#tag_input.tag").focus();
		

	}
}

// evaluate xpath
function xpath(path, node) {
  return document.evaluate(path, node).iterateNext();
}

function buildProbeQuery(probeObj){
	if(probeObj){
		if (probeObj.radius == undefined){
			return 'http://search.twitter.com/search?q=' + probeObj.query + '&ands=&phrase=&ors=&nots=&tag=&lang=all&from=&to=&ref=&near=&within=&units=km&since=&until=&rpp=15';
		}else{
			return 'http://search.twitter.com/search?q=' + probeObj.query + '&ands=&phrase=&ors=&nots=&tag=&lang=all&from=&to=&ref=&near=&within=' + probeObj.radius + '&units=km&since=&until=&rpp=15' + '&geocode=' + escape(probeObj.latitude + ',' + probeObj.longitude + ',' + probeObj.radius + 'km');
		}
	}else{
		return 'about:';
	}
}
function save() {

	
	$('#f').each(function(i){

		/*
		 * validate search term
		 */
		 var tagObj = $(' > input#tag_input.tag',this);

		 if (!tagObj.val()){
			 $(tagObj).addClass('warn');
			 /*
			  * TODO: add warning message
			  */
			 return false;
		 }

		var tagProbe = new Probe();
		tagProbe.query = tagObj.val();
		tagProbe.shortTermTweetsPerMin = 0;
		tagProbe.longTermTweetsPerMin = 0 ;

		chrome.extension.getBackgroundPage().showNoEvents();
		
		probeManager.setProbe(tagProbe);
		$(this).attr('id','f_' + tagProbe.id );

		$(this).addClass('loader');
		$(' > span#btnRefresh',this).addClass('reloading');

		
		
		port.postMessage({probeTagChanged: tagProbe});
		
	});

	//markClean();

	/*
	 * TODO: add communication with background.html
	 */
	 //console.log('TODO: add communication with background.html\n port.postMessage({probeTagAdded: tagProbe})');

	
	//chrome.extension.getBackgroundPage().init();
}

function refreshAll() {

	chrome.extension.getBackgroundPage().updateProbes(function(count) {
		console.log('updateProbes.callback:' + count);
	});

}	

function goToUrl(url) {
chrome.tabs.getAllInWindow(undefined, function(tabs) {
for (var i = 0, tab; tab = tabs[i]; i++) {
  if (tab.url && (tab.url == url)) {
    chrome.tabs.update(tab.id, {selected: true});
    return;
  }
}
chrome.tabs.create({url: url});
});
}	


function back(){
	$("div#options").slideUp("fast");
}

</script>


<div id="header">
	<h1>Social Media Monitoring</h1>
	<div style="position:absolute; top:11px; right: 15px">
		<span class="link" onclick="refreshAll()">Refresh</span> | <span class="link" onclick="goToUrl('options.html');">Options</span> | <span class="link" onclick="window.close()">Close</span>
	</div>
</div>


<div id="config">

<ol id="template" class="probe">
	<li><span id="iconService"></span>
	<span id="tag" class="span_tag hd"><!--  --></span>
	<input type="text" id="tag_input" class="tag" maxlength="30">
	<span class="avgWeek">0</span>
	<span class="avgDay">0</span>
	<span id="btnRemove"></span>
	<span id="btnOptions"></span>
	<span id="btnRefresh" class="idle"></span>
	</li>
</ol>
<ol id="probes">
	<li class="title">
	<span class="tKeywords">Keywords</span>
	<span class="cTpM">cTpM</span>
	<span class="ltTpM">ltTpM</span>
	</li>
</ol>
</div>
<span class="cls"><!--  --></span>

<div id="footr">
<span id="btnAdd"> add new</span>

<div class="option_row" style="padding-top:5px;">
	<div class="option_name">Search results in</div>
	<div class="option_picker">
	<select id="open_results">
		<option value="open_in_current_window">the current window</option>
		<option value="open_in_new_window">a new window</option>
	</select>
	<input id="show-button" type="button" value="Show" onclick="openResults();" disabled="disabled" />
	</div>
</div>
</div>

</body>
</html>