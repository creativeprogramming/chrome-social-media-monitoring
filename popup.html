<html>
<head>
<title>Social Media Monitoring : Popup</title>

<link rel="stylesheet" href="content.css" type="text/css" media="all" />
<script type="text/javascript" src="probe_manager.js"></script>
<script type="text/javascript" src="probe.js"></script>
<script type="text/javascript" src="jquery-1.4.2.min.js"></script>

<script type="text/javascript">
var probeManager = chrome.extension.getBackgroundPage().getProbeManager();

var saveButton;
var probeTags;

var probes, template, inputTag, spanTag, inputAvgWeek, inputAvgDay;

var port = chrome.extension.connect({name: "social-media-monitoring"});

chrome.extension.onConnect.addListener(function(port) {
	  console.assert(port.name == "social-media-monitoring");
	  port.onMessage.addListener(function(msg) {
		console.log('onMessage:' + msg);
		  if (msg.update) {
			  probeTags = msg.update;
			  console.log('onMessage[update]:' + probeTags);

			/*
			 * get right element from probe list
			 */
			  var tagObj = $('#f_' + probeTags.query + '');

				 if (tagObj){

					 $(tagObj).addClass('warn');
					 $(' > span#tag',tagObj).html($(' > input#tag_input',tagObj).val());
					 
					 $(' > span#tag',tagObj).removeClass('hd');
					 $(' > input#tag_input',tagObj).addClass('hd');
					 $(' > input.avgWeek',tagObj).val(probeTags.shortTermTweetsPerHour);
					 $(' > input.avgDay',tagObj).val(probeTags.longTermTweetsPerHour);
				 }

		  }
		  if (msg.alert) {
			  probeTags = msg.alert;
			  console.log('onMessage[alert]:' + probeTags);
		  }	  
	  });
});

$(document).ready(function() {
	$("#btnAdd").click(function() {
		addProbeHTML();
		addRemoveButtonListeners();  
	});

});

function openResults() {
	var tagProbes = probeManager.loadProbes();
	
	if (true) {
		chrome.windows.create({url: tagProbes[0].searchQuery});
		chrome.windows.getLastFocused(function (window) {
		
			for (var j in tagProbes) {
				if (j > 0) {
					chrome.tabs.create({url: tagProbes[j].searchQuery, windowId: window.windowId});
				}
			}
		
		});
	} else {	
	
		for (var i in tagProbes) {
			chrome.tabs.create({url: tagProbes[i].searchQuery});
		}
	
	}
	return false;
}


</script>
</head>
<body onload="setTimeout(init,0);" style="widht: 300px;">

<div id="header">
	<img src="logo_popup.png" title="Social Media Monitoring" alt="Social Media Monitoring" />
    <span class="link" onclick="refresh()">Refresh</span>
    |
    <span class="link" onclick="goToUrl('options.html');">Options</span>
	|
    <span class="link" onclick="window.close()">Close</span>
  </div>



<div class="section-header first">Your Probes</div>
<p>add your search words</p>

<div id="probes">
<div id="template" class="probe"><span id="iconService"></span>
<span id="tag" class="span_tag hd"><!--  --></span>
<input type="text" id="tag_input" class="tag" oninput="markDirty();">

<input type="text" class="avgWeek" disabled="disabled" value="0">
<input type="text" class="avgDay" disabled="disabled" value="0">

<span id="btnRemove"></span> <span id="btnOptions"></span> <span class="clear"><!--  --></span></div>
</div>
<span class="clear"><!--  --></span>
<span id="btnAdd"> add new</span>



<div id="footer" style="display:none;">
<button id="save-button" style="font-weight: bold" onclick="save();">Save</button>
<button onclick="init();">Cancel</button>
</div>

<form id="options_form">
<div class="option_row">
<div class="option_name">Open search results in</div>
<div class="option_picker"><select id="open_results">
	<option value="open_in_new_window">a new window</option>
	<option value="open_in_current_window">the current window</option>
</select></div>
</div>
</form>

<div id="footer">
<button id="save-button" style="font-weight: bold"
	onclick="openResults();return false;">Show results</button>
</div>

<script type="text/javascript">

	function init() {

		/*
			XXX: remove populateDummyData - debugging
		*/
		//probeTags = getDummyData();
		//var probeTags = JSON.parse(localStorage['probes']);

		var probeTags = probeManager.loadProbes();
	

		console.log('TODO: add communication with background.html\n port.postMessage({probeTagLoad: tagProbe})');
			
		saveButton = document.getElementById("save-button");
		markClean();

		probes = document.getElementById('probes');
		template = xpath('//div[@id="template"]', document);
		spanTag  = xpath('//span[@id="tag"]', template);
		inputTag = xpath('//input[@id="tag_input"]', template);
		inputAvgWeek = xpath('//input[@class="avgWeek"]', template);
		inputAvgDay	 = xpath('//input[@class="avgDay"]', template);

		if(probeTags){
			for (var i in probeTags) {
				addProbeHTML(probeTags[i]);
			}
			addRemoveButtonListeners();
		}
	}

	function addRemoveButtonListeners(){
		$("span#btnRemove").click(function() {
			
			var probeDiv = $(this).parent('.probe').css('border','1px dotted #ff0000');


			/*
			 * remove from local storage
			 * TODO: change harcoded values
			 */
			var strDivId = probeDiv.attr('id');
			strDivId = strDivId.substring(2);
			probeManager.removeProbeByKey('twitter' + '_' + strDivId);

			/*
			 * remove from HTML
			 */
			probeDiv.remove();
					
			/*
			 * TODO: add communication with background.html
			 */
			 console.log('TODO: add communication with background.html\n port.postMessage({probeTagDeleted: tagProbe})');

		});

	    $(".probe").click(function () {
	    	       $(".probe").removeClass("selected");
	    	       $(this).addClass("selected");
	    	      }
	    ).mouseover( function () {
			 //$(' > #btnRemove',this).removeClass("hd");
			 $(this).addClass("selected");
			    
			}
		).mouseout( function () {
			//$(' > #btnRemove',this).addClass("hd");
		    $(this).removeClass("selected");
		    	 
		    }
		);

	    $("input#tag_input").keypress(function (e) {  
	        if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {  
				save();
	        	return false;  
	        } else {  
	            return true;  
	        }  
	    });  
		
	    
	}

	function addProbeHTML(tagProbeObj){

		if(tagProbeObj){		

			spanTag.innerHTML = tagProbeObj.query;
			
			spanTag.setAttribute('class','span_tag');			
			inputTag.setAttribute('class','tag hd');
			
			inputTag.setAttribute('value',tagProbeObj.query);
			inputAvgWeek.setAttribute('value',tagProbeObj.shortTermTweetsPerHour);
			inputAvgDay.setAttribute('value',tagProbeObj.longTermTweetsPerHour);
			
			// copy node and update
			item = template.cloneNode(true);	  
			item.setAttribute('id','f_' + tagProbeObj.query);
			
			probes.appendChild(item);
			
		}else{

			spanTag.setAttribute('class','span_tag hd');
			spanTag.innerHTML = '';		
			inputTag.setAttribute('class','tag');
				
			inputTag.setAttribute('value','');
			inputAvgWeek.setAttribute('value','0');
			inputAvgDay.setAttribute('value','0');
			
			// copy node and update
			item = template.cloneNode(true);	  
			item.setAttribute('id','f');

			probes.appendChild(item);

		}
	}
	
	// evaluate xpath
	function xpath(path, node) {
	  return document.evaluate(path, node).iterateNext();
	}

	function save() {

		
		$('#f').each(function(i){

			/*
			 * validate search term
			 */
			 var tagObj = $(' > input#tag_input.tag',this);

			 if (!tagObj.val()){
				 $(tagObj).addClass('warn');
				 /*
				  * TODO: add warning message
				  */
				 return false;
			 }

			var tagProbe = new Probe();
			tagProbe.query = tagObj.val();
			tagProbe.shortTermTweetsPerHour = 0;
			tagProbe.longTermTweetsPerHour = 0 ;
			
			$(this).attr('id','f_' + tagProbe.query );
			
			probeManager.setProbe(tagProbe);
			port.postMessage({probeTagChanged: tagProbe});
			
		});

		//markClean();

		/*
		 * TODO: add communication with background.html
		 */
		 //console.log('TODO: add communication with background.html\n port.postMessage({probeTagAdded: tagProbe})');

		
		//chrome.extension.getBackgroundPage().init();
	}
/*
	function getDummyData(){
		var tagProbes = new Array();

		var tagProbe = new Probe();
		tagProbe.setQuery("#hashtag1");
		tagProbe.searchQuery = "http://search.twitter.com/search.json?&q=" + tagProbe.query;
		
		tagProbes.push(tagProbe);

		tagProbe = new Probe();
		tagProbe.setQuery("#hashtag2");
		tagProbe.searchQuery = "http://search.twitter.com/search.json?&q=" + tagProbe.query;
		tagProbes.push(tagProbe);

		tagProbe = new Probe();
		tagProbe.setQuery("#hashtag3");
		tagProbe.searchQuery = "http://search.twitter.com/search.json?&q=" + tagProbe.query;
		tagProbes.push(tagProbe);
		
		
		return tagProbes;
	}
	*/
	

	function markDirty() {
		saveButton.disabled = false;
	}

	function markClean() {
		saveButton.disabled = true;
	}

  function refresh() {
      startRequest(false);
      document.getElementById('module').src = 'about:blank';
      setIframeUrl();
    }	
	
function goToUrl(url) {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && (tab.url == url)) {
        chrome.tabs.update(tab.id, {selected: true});
        return;
      }
    }
    chrome.tabs.create({url: url});
  });
}	
</script>
</body>
</html>