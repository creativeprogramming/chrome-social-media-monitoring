<html>
<head>
<script type="text/javascript" src="probe_manager.js"></script>
<script type="text/javascript" src="probe.js"></script>
</head>
<body>
<script type="text/javascript">
var LONG_TERM_INTERVAL_IN_HOURS = 24 * 7;
var SHORT_TERM_INTERVAL_IN_HOURS = 1;

var baseURL = "http://search.twitter.com/search.json?";
var probeManager = new ProbeManager();

var port = chrome.extension.connect({name: "social-media-monitoring"});
chrome.extension.onConnect.addListener(function(port) {
	console.assert(port.name == "social-media-monitoring");
	port.onMessage.addListener(function(msg) {
		console.log('BackgroundPage, onMessage:' + msg);
		  
		if (msg.probeTagChanged) {
			var probeTag = msg.probeTagChanged;

			twitterLTQuery = new QueryURL(baseURL, probeTag)
			twitterLTQuery.period = LONG_TERM_INTERVAL_IN_HOURS;
			loadTweets(twitterLTQuery, probeTag);

			twitterSTQuery = new QueryURL(baseURL, probeTag)
			twitterSTQuery.period = SHORT_TERM_INTERVAL_IN_HOURS;
			loadTweets(twitterSTQuery, probeTag);
		}
		if (msg.geocode) {
		  	geocodeLocation(msg.geocode.address, msg.geocode.radius);
		}
		if (msg.requestGeolocation) {
		  	requestGeoLocation();
		}
	});
});

function loadTweets(queryURL) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", queryURL, true);
	xhr.onreadystatechange = function() {
		  if (xhr.readyState == 4){
			  var response = JSON.parse(xhr.responseText);
			  if(response.error){
				  throw new Error('failed to get tweets:' + responseText);
			   }else{
				processResult(queryURL.period, probeTag, response);
			  }
		  }
	};
	xhr.send();
}

function processTweets(period, probeTag, response) {
	var tweetCount = 0;
	var tweets = response.results;
	console.log('Received Tweets: ' + tweets);

	if(period === LONG_TERM_INTERVAL_IN_HOURS){
   		tweetCount = tweets.length;
   		console.log("tweet Count :" + tweetCount);
		probeTag.longTermTweetsPerHour = tweetCount;
	} 
	else if((period === SHORT_TERM_INTERVAL_IN_HOURS)) {
		$.each(tweets, function() { 
			var currTime = new Date();
			var intervalLength = period * 60 * 60 *1000;
			var sinceDateTS = currTime.getTime() - intervalLength;
			var tweetDate = new Date(this.created_at);

			if(sinceDateTS < tweetDate.getTime()) 
				break;

			tweetCount++;
		});

		probeTag.shortTermTweetsPerHour = tweetCount;
	}

	if(probeTag.shortTermTweetsPerHour > probeTag.longTermTweetsPerHour) {
		port.postMessage({alert:probeTag});
	}

	port.postMessage({update:probeTag});
	probeManager.setProbe(probeTag);
}


function locationDetected(position) {
	  var latitude = position.coords.latitude;
	  var longitude = position.coords.longitude;
	  port.postMessage({locationDetected:{latitude:position.coords.latitude,
		  								  longitude:position.coords.longitude}});	  
}

function locationError(msg) {
  var status = typeof msg == 'string' ? msg : "failed";
  port.postMessage({locationError:status});
}

function requestGeoLocation(){
	if (navigator.geolocation) {
	  navigator.geolocation.getCurrentPosition(locationDetected, locationError);
	} else {
		locationError('Geo location not supported! Geolocation is currently only supported in the dev channels Try start chrome with arguments: --enable geolocation');
	}
}

function geocodeLocation(address, radius) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://www.ilimitado.de/labs/chrome/extensions/social-monitor/geocoder.php?loc=" + address, true);
	xhr.onreadystatechange = function() {
	  if (xhr.readyState == 4) {
	    var geocode = JSON.parse(xhr.responseText);
	    var coordinates = geocode.Placemark["Point"].coordinates;

	    port.postMessage({geocoded: coordinates[0] + "," + coordinates[1] + "," + radius + "km"});
	  }
	}
	xhr.send();
}

function getProbeManager() {
	return probeManager;
}

</script>
</body>
</html>