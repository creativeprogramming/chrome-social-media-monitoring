<html>
<head>
</head>
<body>
<script type="text/javascript">
var LONG_TERM_INTERVAL_IN_HOURS = 24 * 7;
var SHORT_TERM_INTERVAL_IN_HOURS = 1;

var baseURL = "http://search.twitter.com/search.json?";

chrome.extension.onConnect.addListener(function(port) {
	console.assert(port.name == "social-media-monitoring");
	port.onMessage.addListener(function(msg) {
		console.log('onMessage:' + msg);
		  
		if (msg.filterTagChanged) {
			var filterTag = msg.filterTagChanged;
			loadTweets(LONG_TERM_INTERVAL_IN_HOURS, filterTag);
			loadTweets(SHORT_TERM_INTERVAL_IN_HOURS, filterTag);
		}
	    
		if (msg.filterTagDeleted) {
		  	removeItem(msg.filterTagChanged.id);
		}
		if (msg.filterTagRequest) {
		  	var requestedfilterTag = getItem(msg.filterTagChanged.id);
		  	port.postMessage({filterTagResponse:requestedfilterTag});
		}
		if (msg.geocode) {
		  	geocodeLocation(msg.geocode.address, msg.geocode.radius);
		}
		if (msg.requestGeolocation) {
		  	requestGeoLocation();
		}
	});
});

function loadTweets(period, filterTag, latitude, longtitude, radius) {
	var query = "q=" + escape(filterTag.id);

	//var sinceDate = new Date("March 05, 2010 09:30:00");
	var sinceDate = getQueryDate(period);
	var since =  "since="+ escape(sinceDate.getFullYear() + "-" + 
  			 sinceDate.getMonth() < 10 ? sinceDate.getMonth() : +"0" + sinceDate.getMonth() + "-" + 
   					 sinceDate.getDay() < 10 ? sinceDate.getDay() : +"0" + sinceDate.getDay());

	var geoLoc = "";

	if(latitude !== undefined && longtitude !== undefined && radius !== undefined) {
		geoLoc = "geocode=" + escape(latitude + "," + longtitude + "," + radius + "km");
	}

	
	var queryURL = baseURL + query + '&' + since + '&' + geoLoc;

	console.log('XHRQueryURL:' + queryURL);
	
	var xhr = new XMLHttpRequest();
	xhr.open("GET", queryURL, true);
	xhr.onreadystatechange = function() {
		  if (xhr.readyState == 4){
			  var response = JSON.parse(xhr.responseText);
			  if(response.error){
				  throw new Error('failed to get tweets:' + responseText);
			   }else{
				processResult(period, filterTag, response);
			  }
		  }
	};
	xhr.send();
}

function getQueryDate(period) {
	var currentTime = new Date();
	var timeIntervalInMS = period * 60 * 60 *1000;
	return new Date(currentTime - timeIntervalInMS);
}

function processResult(period, filterTag, result) {
	var port = chrome.extension.connect({name: "social-media-monitoring"});

	var tweets = result.results;

	if(!tweets){
		throw new Error('failed to get tweets:' + responseText);
	}
	
	tweetsPerHour = tweets.length / period;
   	if(period === LONG_TERM_INTERVAL_IN_HOURS){
		filterTag.longTermTweetsPerHour = tweetsPerHour;
	} else if((period === SHORT_TERM_INTERVAL_IN_HOURS)) {
		filterTag.shortTermTweetsPerHour = tweetsPerHour;
	}

   	/*
	 * TODO: check if this code line is right
	 * 	if(filterTag.shortTermTweetsPerHour > filterTag.longTermTweetsPerHour = tweetsPerHour){
     */

	if(filterTag.shortTermTweetsPerHour > filterTag.longTermTweetsPerHour) {
		port.postMessage({alert:filterTag});
	}

	port.postMessage({update:filterTag});
	setItem(filterTag.id, filterTag);
}


function locationDetected(position) {
	  var latitude = position.coords.latitude;
	  var longitude = position.coords.longitude;
	  port.postMessage({locationDetected:{latitude:position.coords.latitude,
		  								  longitude:position.coords.longitude}});	  
}

function locationError(msg) {
  var status = typeof msg == 'string' ? msg : "failed";
  port.postMessage({locationError:status});
}

function requestGeoLocation(){
	if (navigator.geolocation) {
	  navigator.geolocation.getCurrentPosition(locationDetected, locationError);
	} else {
		locationError('Geo location not supported! Geolocation is currently only supported in the dev channels Try start chrome with arguments: --enable geolocation');
	}
}

function geocodeLocation(address, radius) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://www.ilimitado.de/labs/chrome/extensions/social-monitor/geocoder.php?loc=" + address, true);
	xhr.onreadystatechange = function() {
	  if (xhr.readyState == 4) {
	    var geocode = JSON.parse(xhr.responseText);
	    var coordinates = geocode.Placemark["Point"].coordinates;

	    port.postMessage({geocoded: coordinates[0] + "," + coordinates[1] + "," + radius + "km"});
	  }
	}
	xhr.send();
}

function setItem(key, value) {
	try {
		console.log('Set Item:' + key);
		window.localStorage.removeItem(key);
		window.localStorage.setItem(key, value);
	}catch(e) {
		console.log("Error writing item to localstorage for key: " + key + " value: " + value);
		console.log(e);
	}
}

function getItem(key) {
	var value;
	console.log('Get Item:' + key);
	try {
		value = window.localStorage.getItem(key);
	}catch(e) {
	console.log("Error getting item to localstorage for key:" + key);
	 	 console.log(e);
	  	value = null;
	}
}

function removeItem(key) {
	try {
		console.log('Remove Item:' + key);
		window.localStorage.removeItem(key);
	}catch(e) {
		console.log("Error removing item to localstorage for key: " + key);
		console.log(e);
	}
}
</script>
</body>
</html>