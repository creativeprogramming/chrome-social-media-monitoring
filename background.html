<html>
<head>
</head>
<body>
<script type="text/javascript">
var LONG_TERM = 24 * 7;
var SHORT_TERM = 1;

/**
 * TODO: implement
 *
 * 	port.postMessage({filtereTagChanged: tagFilter});
 *	port.postMessage({filtereTagDeleted: tagFilter});
 *	port.postMessage({filtereTagAdded: tagFilter});
 *
 */
 
chrome.extension.onConnect.addListener(function(port) {
	  console.assert(port.name == "social-media-monitoring");
	  port.onMessage.addListener(function(msg) {
	    if (msg.filterTagChanged) {
			var filterTag = msg.filterTagChanged;
			loadTweets(LONG_TERM, filterTag);
			loadTweets(SHORT_TERM, filterTag);
	    }
	  });
	});

function setItem(key, value) {
	try {
		console.log('Set Item:' + key);
		window.localStorage.removeItem(key);
		window.localStorage.setItem(key, value);
	}catch(e) {
		console.log("Error writing item to localstorage for key: " + key + " value: " + value);
		console.log(e);
	}
}

function getItem(key) {
	var value;
	console.log('Get Item:' + key);
	try {
		value = window.localStorage.getItem(key);
	}catch(e) {
	console.log("Error getting item to localstorage for key:" + key);
	 	 console.log(e);
	  	value = null;
}

function loadTweets(period, filterTag) {
	var req = new XMLHttpRequest();
	req.open(
		"GET",
	    "http://search.twitter.com/search.json?" + "q="+escape(filterTag.id),
	    true);
	req.onload = function() {
		processResult(period, filterTag);
	};
 	req.send(null);
}

function processResult(period, filterTag) {
	console.log("processResults");
	  var tweets = JSON.parse(req.responseText).results;
	  var currTime = new Date();
	  var interval = period * 60 * 60 *1000;
	  var diff = curTime - interval;
	  var count=0;
	  for (; count < tweets.length; count++) {
		var currDate = new Date(results[count].created_at);
		var ts = currDate.getTime();
		if(diff > ts)
			break;
	  }
      tweetsPerHour=count/period;		
      if(period == LONG_TERM)
          filterTag.longTermTweetsPerHour=tweetsPerHour;
	  } else {
		  filterTag.shortTermTweetsPerHour=tweetsPerHour;
	  }
}


function locationDetected(position) {
	  var latitue = position.coords.latitude;
	  var longtitue = position.coords.longitude;
	  //port.postMessage({locationDetected:{latitude:position.coords.latitude,
		  								  longitude:position.coords.longitude}});	  
}

function locationError(msg) {
  var status = typeof msg == 'string' ? msg : "failed";
  //port.postMessage({locationError:status});
}

function getGeoLocation()
	if (navigator.geolocation) {
	  navigator.geolocation.getCurrentPosition(locationDetected, locationError);
	} else {
		locationError('Geo location not supported! Geolocation is currently only supported in the dev channels Try start chrome with arguments: --enable geolocation');
	}
}

</script>

</body>
</html>


